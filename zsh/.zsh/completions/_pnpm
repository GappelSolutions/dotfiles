#compdef pnpm

# pnpm completion - auto-generated, regenerate with:
# pnpm completion zsh > ~/.zsh/completions/_pnpm

_pnpm() {
  local -a commands
  commands=(
    'add:Install a package'
    'install:Install all dependencies'
    'remove:Remove a package'
    'update:Update packages'
    'run:Run a script'
    'test:Run tests'
    'build:Build the project'
    'start:Start the project'
    'dev:Run in development mode'
    'exec:Execute a command'
    'dlx:Run a package without installing'
    'create:Create a project from a template'
    'init:Initialize a package.json'
    'publish:Publish a package'
    'pack:Create a tarball'
    'link:Link a package'
    'unlink:Unlink a package'
    'why:Show why a package is installed'
    'list:List installed packages'
    'outdated:Show outdated packages'
    'audit:Audit dependencies'
    'licenses:List licenses'
    'store:Manage the pnpm store'
    'root:Print the root directory'
    'bin:Print the bin directory'
    'setup:Setup pnpm'
    'env:Manage Node.js versions'
  )

  _arguments -C \
    '1:command:->command' \
    '*::arg:->args'

  case "$state" in
    command)
      _describe -t commands 'pnpm command' commands
      ;;
    args)
      case "$words[1]" in
        run)
          # Try to get scripts from package.json
          if [[ -f package.json ]]; then
            local -a scripts
            scripts=(${(f)"$(grep -E '^\s+"[^"]+":' package.json 2>/dev/null | sed -n '/"scripts"/,/}/p' | grep -oE '"[^"]+":' | tr -d '":' | tail -n +2)"})
            _describe -t scripts 'npm script' scripts
          fi
          ;;
      esac
      ;;
  esac
}

_pnpm "$@"
