# Nix Darwin Configuration

Declarative macOS configuration using nix-darwin, home-manager, and agenix.

## The "Nuke and Pave" Promise

Lost your laptop? New machine? One command:

```bash
curl -fsSL https://raw.githubusercontent.com/GappelSolutions/dotfiles/main/nix/bootstrap.sh | bash
```

The script will:
1. Install Nix
2. Clone this repo
3. Prompt for your master passphrase
4. Decrypt your SSH keys
5. Build your entire system
6. Prompt for service logins (gh, az, claude)

## Architecture

```
nix/
├── flake.nix                 # Entry point, declares inputs
├── darwin-configuration.nix  # System-level: macOS defaults, Homebrew casks, agenix
├── home.nix                  # User-level: packages, shell, dotfiles
├── secrets/
│   ├── secrets.nix           # Declares which keys can decrypt which secrets
│   ├── ssh-github-personal.age
│   ├── ssh-github-work.age
│   └── ssh-azure.age
├── bootstrap.sh              # Fresh machine setup script
└── README.md                 # You are here
```

## How It Works

### Secrets (agenix)

Your SSH keys are encrypted with `age` and committed to the repo. Only someone with your master key can decrypt them.

```
master.key (on your machine, passphrase-protected backup elsewhere)
    |
    v
[decrypts]
    |
    v
ssh-github-personal.age --> ~/.ssh/id_ed25519
ssh-github-work.age     --> ~/.ssh/id_ed25519_work
ssh-azure.age           --> ~/.ssh/id_azure
```

### The Master Key

- Lives at `~/.age/master.key`
- An encrypted backup (`master.key.age`) is created during setup
- **Store this backup somewhere safe** (USB drive, printed QR code, etc.)
- The passphrase for this backup is your "one password"

### Rebuild Workflow

After changing any config:

```bash
cd ~/dev/dotfiles/nix
darwin-rebuild switch --flake .

# Or use the alias:
rebuild
```

## Fresh Machine Setup

### Quick Start

```bash
# From a fresh Mac:
curl -fsSL https://raw.githubusercontent.com/GappelSolutions/dotfiles/main/nix/bootstrap.sh | bash
```

### What Gets Prompted

1. **Xcode CLI Tools** - Wait for installation
2. **Master Key** - Either:
   - Provide path to encrypted backup + passphrase
   - Or generate new key (first-time setup)
3. **SSH Keys** - Paths to your existing private keys (first-time only)
4. **Hostname** - Name for this machine
5. **Service Auth** - Browser-based OAuth for:
   - `gh auth login` (GitHub)
   - `az login` (Azure)
   - `claude login` (Claude Code)

## Adding New Secrets

```bash
cd ~/dev/dotfiles/nix/secrets

# Edit secrets.nix to add the new secret declaration
# Then encrypt:
age -r "$(age-keygen -y ~/.age/master.key)" -o new-secret.age /path/to/secret

# Commit the .age file
git add new-secret.age
git commit -m "chore: add new secret"
```

## Common Tasks

### Add a New Package

Edit `home.nix`:

```nix
home.packages = with pkgs; [
  # ... existing packages
  new-package
];
```

Then: `rebuild`

### Add a Homebrew Cask

Edit `darwin-configuration.nix`:

```nix
homebrew.casks = [
  # ... existing casks
  "new-app"
];
```

Then: `rebuild`

### Change macOS Defaults

Edit `darwin-configuration.nix`:

```nix
system.defaults = {
  dock.autohide = true;
  # ... etc
};
```

Then: `rebuild`

### Update All Packages

```bash
cd ~/dev/dotfiles/nix
nix flake update
rebuild
```

## Rollback

Made a mistake? Roll back to the previous generation:

```bash
darwin-rebuild switch --rollback

# Or list generations and pick one:
darwin-rebuild --list-generations
darwin-rebuild switch --generation 42
```

## Directory Structure After Setup

```
~/.age/
├── master.key          # Your age private key (NEVER commit this)
└── master.key.age      # Encrypted backup (safe to store elsewhere)

~/.ssh/
├── id_ed25519          # GitHub personal (decrypted by agenix)
├── id_ed25519_work     # GitHub work (decrypted by agenix)
├── id_azure            # Azure DevOps (decrypted by agenix)
└── config              # Generated by home-manager

~/.config/
├── nvim/               # Symlinked by home-manager
├── alacritty/
├── lazygit/
├── yazi/
└── zellij/

~/.aerospace.toml       # Symlinked by home-manager
```

## Troubleshooting

### "error: file 'darwin' was not found"

First-time nix-darwin install. Run:

```bash
nix run nix-darwin -- switch --flake .
```

### "age: error: no identity matched any of the recipients"

Your master key doesn't match the public key in `secrets.nix`. Either:
- You're using the wrong master key
- You need to re-encrypt secrets with your current key

### Conflicting files during rebuild

Home-manager won't overwrite existing files. Remove or move them:

```bash
# Example: existing nvim config
mv ~/.config/nvim ~/.config/nvim.backup
rebuild
```

### Homebrew cask installation fails

Some casks need manual intervention (e.g., security prompts). Install manually:

```bash
brew install --cask problematic-cask
```

## Philosophy

1. **Declarative** - The repo IS the system. No hidden state.
2. **Reproducible** - Same config = same machine, every time.
3. **Secrets stay secret** - Encrypted at rest, decrypted at runtime.
4. **No vendor lock-in** - age is a simple tool, keys are files, no cloud.
5. **Prompted auth** - Service credentials are entered manually, not automated.

## Migration from Stow

This setup replaces the stow-based workflow. The old `init.sh` and stow configs remain in the repo for reference but aren't used by the Nix setup.

The Nix configuration imports your existing dotfiles directly:
- `../nvim/.config/nvim` -> `~/.config/nvim`
- etc.

No changes needed to your actual config files.
