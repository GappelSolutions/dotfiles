#!/usr/bin/env bash

# Zellij Session Picker (minimal)

# Clean up sessions that don't match our naming template
cleanup_sessions() {
  zellij list-sessions 2>/dev/null | sed 's/\x1b\[[0-9;]*m//g' | while read -r line; do
    session_name=$(echo "$line" | awk '{print $1}')
    # Skip current session
    [[ "$line" == *"(current)"* ]] && continue
    # Keep sessions matching our patterns
    case "$session_name" in
      energyboard-*|backoffice-*|easyasset-*|elixir-*|gappel-solutions-*|decon-*|screensaver-*|new-*) continue ;;
      *) zellij delete-session --force "$session_name" 2>/dev/null ;;
    esac
  done
}

cleanup_sessions

# Session options
SESSIONS="energyboard
backoffice
easyasset
elixir
gappel-solutions
decon
screensaver
new
welcome"

# Run fzf
selected=$(echo "$SESSIONS" | fzf \
  --height=100% \
  --layout=reverse \
  --no-info \
  --no-separator \
  --prompt="❯ " \
  --header="Sessions" \
  --color='bg+:-1,pointer:magenta,prompt:yellow,hl:cyan,hl+:cyan,header:magenta:bold,gutter:-1' \
  --pointer='▶ ' \
  --marker=' ' \
  --no-scrollbar \
  2>/dev/null)

# Plugin path
PLUGIN="file:$HOME/dev/dotfiles/zellij/.config/zellij/plugins/zellij-switch.wasm"

# Handle selection
if [[ -z "$selected" ]]; then
  zellij action launch-or-focus-plugin "session-manager" --floating
  exit 0
fi

case "$selected" in
  "new")
    session_name="new-$(date +%Y%m%d-%H%M%S)"
    zellij pipe --plugin "$PLUGIN" -- "-s $session_name -l new"
    exit 0
    ;;
  "welcome")
    zellij action launch-or-focus-plugin "session-manager" --floating
    exit 0
    ;;
esac

layout="$selected"

# Check for existing active session
existing=$(zellij list-sessions 2>/dev/null | sed 's/\x1b\[[0-9;]*m//g' | grep "^$layout-" | grep -v "EXITED" | awk '{print $1}' | head -1)

if [[ -n "$existing" ]]; then
  zellij pipe --plugin "$PLUGIN" -- "-s $existing"
else
  session_name="$layout-$(date +%Y%m%d-%H%M%S)"
  zellij pipe --plugin "$PLUGIN" -- "-s $session_name -l $layout"
fi
